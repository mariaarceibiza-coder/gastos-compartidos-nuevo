<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Gestor de Gastos</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; }
        .bg-gradient { background: linear-gradient(135deg, #EFF6FF 0%, #E0E7FF 100%); min-height: 100vh; padding: 1rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1rem; }
        .header { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: space-between; }
        .header-title { display: flex; align-items: center; gap: 1rem; }
        .icon-box { background: #4F46E5; padding: 0.75rem; border-radius: 0.75rem; color: white; }
        .title { font-size: 1.5rem; font-weight: bold; color: #1F2937; }
        .subtitle { font-size: 0.875rem; color: #6B7280; }
        .sync-badge { font-size: 0.75rem; color: #16A34A; display: flex; align-items: center; gap: 0.25rem; }
        .date-selector { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .select, .input { padding: 0.5rem 1rem; border: 2px solid #C7D2FE; border-radius: 0.5rem; font-weight: 600; }
        .input-sm { width: 5rem; }
        .grid { display: grid; gap: 1rem; }
        @media (min-width: 768px) { .grid { grid-template-columns: repeat(2, 1fr); } }
        .section-title { font-size: 1.125rem; font-weight: bold; color: #1F2937; margin-bottom: 1rem; }
        .green-box { background: #F0FDF4; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
        .purple-box { background: #FAF5FF; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border: 2px solid #E9D5FF; }
        .label { display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
        .input-full { width: 100%; padding: 0.5rem 1rem; border: 2px solid #86EFAC; border-radius: 0.5rem; font-size: 1.125rem; font-weight: bold; }
        .input-purple { width: 100%; padding: 0.5rem 1rem; border: 2px solid #C084FC; border-radius: 0.5rem; font-size: 1.125rem; font-weight: bold; }
        .gasto-list { max-height: 24rem; overflow-y: auto; margin-bottom: 1rem; }
        .gasto-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 0.5rem; }
        .gasto-item:hover { background: #F9FAFB; }
        .gasto-item.pagado { background: #F0FDF4; }
        .checkbox { width: 1.25rem; height: 1.25rem; cursor: pointer; }
        .gasto-text { flex: 1; font-size: 0.875rem; color: #374151; }
        .gasto-text.pagado { text-decoration: line-through; color: #9CA3AF; }
        .gasto-amount { font-weight: 600; font-size: 0.875rem; color: #1F2937; white-space: nowrap; }
        .gasto-amount.pagado { color: #16A34A; }
        .btn-icon { padding: 0.25rem; cursor: pointer; border: none; background: transparent; border-radius: 0.25rem; }
        .btn-icon:hover { background: #F3F4F6; }
        .btn { width: 100%; padding: 0.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-small { padding: 0.5rem 1rem; width: auto; font-size: 0.875rem; }
        .btn-add { background: #E0E7FF; color: #4F46E5; }
        .btn-add:hover { background: #C7D2FE; }
        .btn-primary { background: #4F46E5; color: white; }
        .btn-primary:hover { background: #4338CA; }
        .btn-secondary { background: #E5E7EB; color: #374151; }
        .btn-secondary:hover { background: #D1D5DB; }
        .summary { border-top: 2px solid #E5E7EB; padding-top: 1rem; margin-top: 1.5rem; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .summary-label { color: #374151; font-weight: bold; }
        .summary-value { font-weight: bold; }
        .text-red { color: #DC2626; }
        .text-green { color: #16A34A; }
        .text-orange { color: #EA580C; }
        .text-sm { font-size: 0.75rem; }
        .text-xl { font-size: 1.25rem; }
        .daily-box { background: #EEF2FF; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .alert { padding: 1rem; border-radius: 0.5rem; border: 2px solid; margin-bottom: 1.5rem; }
        .alert-green { background: #F0FDF4; border-color: #86EFAC; }
        .alert-orange { background: #FFF7ED; border-color: #FED7AA; }
        .alert-red { background: #FEF2F2; border-color: #FCA5A5; }
        .alert-content { display: flex; gap: 0.75rem; }
        .alert-icon { padding: 0.5rem; border-radius: 9999px; font-size: 1.25rem; flex-shrink: 0; }
        .alert-icon.green { background: #BBF7D0; }
        .alert-icon.orange { background: #FED7AA; }
        .alert-icon.red { background: #FCA5A5; }
        .alert-title { font-weight: bold; margin-bottom: 0.5rem; }
        .progress-bar { width: 100%; background: #E5E7EB; border-radius: 9999px; height: 1.25rem; overflow: hidden; margin-bottom: 1.5rem; }
        .progress-fill { height: 100%; transition: width 0.5s; }
        .bg-green-500 { background: #22C55E; }
        .bg-orange-500 { background: #F97316; }
        .bg-red-500 { background: #EF4444; }
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
        .stat-box { padding: 0.75rem; border-radius: 0.5rem; }
        .stat-box.blue { background: #EFF6FF; }
        .stat-box.red { background: #FEF2F2; }
        .stat-box.green { background: #F0FDF4; }
        .stat-box.full { grid-column: span 2; }
        .stat-label { font-size: 0.75rem; color: #6B7280; margin-bottom: 0.25rem; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .form-box { background: #EEF2FF; padding: 1rem; border-radius: 0.5rem; }
        .form-title { font-weight: 600; color: #312E81; margin-bottom: 0.75rem; }
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .input-form { width: 100%; padding: 0.5rem 0.75rem; border: 2px solid #C7D2FE; border-radius: 0.5rem; }
        table { width: 100%; }
        th { text-align: left; padding: 0.5rem; font-weight: 600; color: #374151; font-size: 0.875rem; border-bottom: 2px solid #E5E7EB; }
        td { padding: 0.5rem; font-size: 0.875rem; border-bottom: 1px solid #F3F4F6; }
        tr:hover { background: #F9FAFB; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .empty-state { text-align: center; color: #6B7280; padding: 2rem; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-content { background: white; border-radius: 1rem; padding: 1.5rem; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-title { font-size: 1.25rem; font-weight: bold; color: #1F2937; }
        .btn-close { background: #F3F4F6; border: none; border-radius: 0.5rem; padding: 0.5rem; cursor: pointer; font-size: 1.25rem; }
        .btn-close:hover { background: #E5E7EB; }
        .historico-item { padding: 1rem; border: 2px solid #E5E7EB; border-radius: 0.5rem; margin-bottom: 0.75rem; cursor: pointer; }
        .historico-item:hover { border-color: #C7D2FE; background: #F9FAFB; }
        .historico-mes { font-weight: bold; color: #1F2937; margin-bottom: 0.5rem; }
        .historico-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.875rem; }
        .loading { text-align: center; padding: 2rem; color: #6B7280; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyB3kiy6fyLoAgCEH0Kw7K_iQt8YkebY9UY",
            authDomain: "gastos-familia-marce.firebaseapp.com",
            projectId: "gastos-familia-marce",
            storageBucket: "gastos-familia-marce.firebasestorage.app",
            messagingSenderId: "117082983018",
            appId: "1:117082983018:web:59a5bfd4a3e015d7251813"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const { useState, useEffect } = React;

        function App() {
            const [ingresos, setIngresos] = useState(3350);
            const [saldoAhorro, setSaldoAhorro] = useState(0);
            const [gastosFijos, setGastosFijos] = useState([
                { id: 1, categoria: 'Alquiler', presupuesto: 950, pagado: false },
                { id: 2, categoria: 'Coche', presupuesto: 400, pagado: false },
                { id: 3, categoria: 'GuarderÃ­a', presupuesto: 340, pagado: false },
                { id: 4, categoria: 'TelÃ©fono', presupuesto: 39.10, pagado: false },
                { id: 5, categoria: 'Luz', presupuesto: 42, pagado: false },
                { id: 6, categoria: 'Parking', presupuesto: 121, pagado: false },
                { id: 7, categoria: 'Gas', presupuesto: 40, pagado: false },
                { id: 8, categoria: 'Tarjeta cumple Bruno', presupuesto: 50, pagado: false },
                { id: 9, categoria: 'Agua', presupuesto: 100, pagado: false },
                { id: 10, categoria: 'Ahorro', presupuesto: 250, pagado: false }
            ]);
            const [gastosVariables, setGastosVariables] = useState([]);
            const [mesActual, setMesActual] = useState(new Date().getMonth());
            const [aÃ±oActual, setAÃ±oActual] = useState(new Date().getFullYear());
            const [editingFijo, setEditingFijo] = useState(null);
            const [nuevoGasto, setNuevoGasto] = useState({ fecha: '', monto: '', descripcion: '' });
            const [mostrarHistorico, setMostrarHistorico] = useState(false);
            const [historico, setHistorico] = useState({});
            const [loading, setLoading] = useState(true);
            const [synced, setSynced] = useState(false);

            const mesKey = `${aÃ±oActual}-${mesActual}`;

            useEffect(() => {
                const unsubscribe = db.collection('gastos').doc('data').onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        setIngresos(data.ingresos || 3350);
                        setGastosFijos(data.gastosFijos || gastosFijos);
                        setSaldoAhorro(data.saldoAhorro || 0);
                        setHistorico(data.historico || {});
                        
                        const mesData = data.historico?.[mesKey];
                        if (mesData) {
                            setGastosVariables(mesData.gastosVariables || []);
                        } else {
                            setGastosVariables([]);
                        }
                    }
                    setLoading(false);
                    setSynced(true);
                    setTimeout(() => setSynced(false), 2000);
                });

                return () => unsubscribe();
            }, [mesKey]);

            useEffect(() => {
                if (loading) return;

                const nuevoHistorico = {
                    ...historico,
                    [mesKey]: {
                        gastosVariables,
                        ingresos,
                        gastosFijos: gastosFijos.map(g => ({...g})),
                        totalGastosFijos: gastosFijos.reduce((sum, g) => sum + g.presupuesto, 0),
                        totalGastosVariables: gastosVariables.reduce((sum, g) => sum + g.monto, 0)
                    }
                };

                db.collection('gastos').doc('data').set({
                    ingresos,
                    gastosFijos,
                    saldoAhorro,
                    historico: nuevoHistorico,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    setSynced(true);
                    setTimeout(() => setSynced(false), 2000);
                });

                setHistorico(nuevoHistorico);
            }, [ingresos, gastosFijos, gastosVariables, saldoAhorro, mesKey]);

            const totalGastosFijos = gastosFijos.reduce((sum, g) => sum + g.presupuesto, 0);
            const totalGastosFijosPagados = gastosFijos.filter(g => g.pagado).reduce((sum, g) => sum + g.presupuesto, 0);
            const totalGastosFijosPendientes = gastosFijos.filter(g => !g.pagado).reduce((sum, g) => sum + g.presupuesto, 0);
            const resto = ingresos - totalGastosFijos;
            const diasMes = new Date(aÃ±oActual, mesActual + 1, 0).getDate();
            const presupuestoDiario = resto / diasMes;
            const totalGastosVariables = gastosVariables.reduce((sum, g) => sum + g.monto, 0);
            const presupuestoRestante = resto - totalGastosVariables;

            const hoy = new Date();
            const diaActual = hoy.getDate();
            const diasRestantes = diasMes - diaActual;
            const gastoPromedioDiario = diaActual > 0 ? totalGastosVariables / diaActual : 0;
            const proyeccionFinMes = totalGastosVariables + (gastoPromedioDiario * diasRestantes);
            const diferenciaPrevista = resto - proyeccionFinMes;
            const estadoProyeccion = diferenciaPrevista >= 0 ? 'bien' : diferenciaPrevista >= -100 ? 'ajustado' : 'peligro';
            const porcentajeGastado = (totalGastosVariables / resto) * 100;

            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            const cargarMesHistorico = (key) => {
                const [aÃ±o, mes] = key.split('-').map(Number);
                setAÃ±oActual(aÃ±o);
                setMesActual(mes);
                setMostrarHistorico(false);
            };

            const historicoOrdenado = Object.keys(historico).sort().reverse();

            if (loading) {
                return (
                    <div className="bg-gradient">
                        <div className="container">
                            <div className="loading">
                                <div style={{fontSize: '2rem', marginBottom: '1rem'}}>ðŸ’°</div>
                                <div>Cargando datos...</div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="bg-gradient">
                    <div className="container">
                        <div className="card">
                            <div className="header">
                                <div className="header-title">
                                    <div className="icon-box">ðŸ’°</div>
                                    <div>
                                        <div className="title">Gestor de Gastos</div>
                                        <div className="subtitle">
                                            Control mensual compartido
                                            {synced && <span className="sync-badge"> âœ“ Sincronizado</span>}
                                        </div>
                                    </div>
                                </div>
                                <div className="date-selector">
                                    <button className="btn btn-small btn-secondary" onClick={() => setMostrarHistorico(true)}>
                                        ðŸ“Š HistÃ³rico
                                    </button>
                                    <select className="select" value={mesActual} onChange={e => setMesActual(parseInt(e.target.value))}>
                                        {meses.map((mes, i) => <option key={i} value={i}>{mes}</option>)}
                                    </select>
                                    <input className="select input-sm" type="number" value={aÃ±oActual} onChange={e => setAÃ±oActual(parseInt(e.target.value))} />
                                </div>
                            </div>
                        </div>

                        <div className="grid">
                            <div className="card">
                                <div className="section-title">Estado del Presupuesto</div>
                                <div className={`alert ${estadoProyeccion === 'bien' ? 'alert-green' : estadoProyeccion === 'ajustado' ? 'alert-orange' : 'alert-red'}`}>
                                    <div className="alert-content">
                                        <div className={`alert-icon ${estadoProyeccion === 'bien' ? 'green' : estadoProyeccion === 'ajustado' ? 'orange' : 'red'}`}>
                                            {estadoProyeccion === 'bien' ? 'âœ“' : 'âš '}
                                        </div>
                                        <div style={{flex:1}}>
                                            <div className="alert-title text-sm">{estadoProyeccion === 'bien' ? 'Â¡Vas genial!' : estadoProyeccion === 'ajustado' ? 'Vas un poco justo' : 'Â¡Cuidado! Te vas a pasar'}</div>
                                            <div className="text-sm">
                                                <div><strong>DÃ­as restantes:</strong> {diasRestantes} dÃ­as</div>
                                                <div><strong>Gasto promedio:</strong> {gastoPromedioDiario.toFixed(2)} â‚¬/dÃ­a</div>
                                                <div><strong>ProyecciÃ³n:</strong> {proyeccionFinMes.toFixed(2)} â‚¬</div>
                                                <div style={{marginTop:'0.5rem',fontWeight:'bold'}}>
                                                    {diferenciaPrevista >= 0 ? `Te sobrarÃ¡n ${diferenciaPrevista.toFixed(2)} â‚¬` : `Te faltarÃ¡n ${Math.abs(diferenciaPrevista).toFixed(2)} â‚¬`}
                                                </div>
                                                {estadoProyeccion !== 'bien' && <div className="text-sm" style={{marginTop:'0.5rem'}}>ðŸ’¡ MÃ¡ximo {(presupuestoRestante / diasRestantes).toFixed(2)} â‚¬/dÃ­a</div>}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div style={{marginBottom:'1rem'}}>
                                    <div style={{display:'flex',justifyContent:'space-between',marginBottom:'0.5rem'}}>
                                        <span style={{fontWeight:'600'}}>Gastado</span>
                                        <span style={{fontWeight:'bold',color:'#4F46E5'}}>{porcentajeGastado.toFixed(1)}%</span>
                                    </div>
                                    <div className="progress-bar">
                                        <div className={`progress-fill ${porcentajeGastado > 90 ? 'bg-red-500' : porcentajeGastado > 70 ? 'bg-orange-500' : 'bg-green-500'}`} style={{width: `${Math.min(porcentajeGastado, 100)}%`}}></div>
                                    </div>
                                </div>
                                <div className="stats">
                                    <div className="stat-box blue" style={{background:'#EFF6FF'}}>
                                        <div className="stat-label">Presupuesto</div>
                                        <div className="stat-value" style={{color:'#2563EB'}}>{resto.toFixed(2)} â‚¬</div>
                                    </div>
                                    <div className="stat-box red">
                                        <div className="stat-label">Gastado</div>
                                        <div className="stat-value text-red">{totalGastosVariables.toFixed(2)} â‚¬</div>
                                    </div>
                                    <div className="stat-box green full">
                                        <div className="stat-label">Restante</div>
                                        <div className="stat-value text-green" style={{fontSize:'2rem'}}>{presupuestoRestante.toFixed(2)} â‚¬</div>
                                    </div>
                                </div>
                                <div className="form-box">
                                    <div className="form-title">AÃ±adir Gasto</div>
                                    <div className="input-group">
                                        <input className="input-form" type="date" value={nuevoGasto.fecha} onChange={e => setNuevoGasto({...nuevoGasto, fecha: e.target.value})} />
                                        <input className="input-form" type="number" placeholder="Importe (â‚¬)" value={nuevoGasto.monto} onChange={e => setNuevoGasto({...nuevoGasto, monto: e.target.value})} step="0.01" />
                                        <input className="input-form" type="text" placeholder="DescripciÃ³n" value={nuevoGasto.descripcion} onChange={e => setNuevoGasto({...nuevoGasto, descripcion: e.target.value})} />
                                        <button className="btn btn-primary" onClick={() => {
                                            if (nuevoGasto.fecha && nuevoGasto.monto) {
                                                setGastosVariables([...gastosVariables, {id: Date.now(), fecha: nuevoGasto.fecha, monto: parseFloat(nuevoGasto.monto), descripcion: nuevoGasto.descripcion || ''}]);
                                                setNuevoGasto({fecha: '', monto: '', descripcion: ''});
                                            }
                                        }}>+ AÃ±adir Gasto</button>
                                    </div>
                                </div>
                            </div>

                            <div className="card">
                                <div className="section-title">Ingresos y Gastos Fijos</div>
                                <div className="green-box">
                                    <label className="label">Ingresos Mensuales</label>
                                    <input className="input-full" type="number" value={ingresos} onChange={e => setIngresos(parseFloat(e.target.value) || 0)} step="0.01" />
                                </div>
                                <div className="purple-box">
                                    <label className="label">ðŸ’° Saldo Total en Cuenta de Ahorro</label>
                                    <input className="input-purple" type="number" value={saldoAhorro} onChange={e => setSaldoAhorro(parseFloat(e.target.value) || 0)} step="0.01" />
                                    <div style={{marginTop:'0.5rem',fontSize:'0.75rem',color:'#6B7280'}}>
                                        Este es tu saldo acumulado total en la cuenta de ahorro
                                    </div>
                                </div>
                                <div className="gasto-list">
                                    {gastosFijos.map(g => (
                                        <div key={g.id} className={`gasto-item ${g.pagado ? 'pagado' : ''}`}>
                                            <input className="checkbox" type="checkbox" checked={g.pagado} onChange={() => {
                                                setGastosFijos(gastosFijos.map(x => x.id === g.id ? {...x, pagado: !x.pagado} : x));
                                            }} />
                                            {editingFijo === g.id ? (
                                                <>
                                                    <input className="input" style={{flex:1}} value={g.categoria} onChange={e => {
                                                        setGastosFijos(gastosFijos.map(x => x.id === g.id ? {...x, categoria: e.target.value} : x));
                                                    }} />
                                                    <input className="input" style={{width:'5rem'}} type="number" value={g.presupuesto} onChange={e => {
                                                        setGastosFijos(gastosFijos.map(x => x.id === g.id ? {...x, presupuesto: parseFloat(e.target.value) || 0} : x));
                                                    }} step="0.01" />
                                                    <button className="btn-icon" onClick={() => setEditingFijo(null)}>âœ“</button>
                                                </>
                                            ) : (
                                                <>
                                                    <span className={`gasto-text ${g.pagado ? 'pagado' : ''}`}>{g.categoria}</span>
                                                    <span className={`gasto-amount ${g.pagado ? 'pagado' : ''}`}>{g.presupuesto.toFixed(2)} â‚¬</span>
                                                    <button className="btn-icon" onClick={() => setEditingFijo(g.id)}>âœŽ</button>
                                                    <button className="btn-icon" onClick={() => setGastosFijos(gastosFijos.filter(x => x.id !== g.id))}>ðŸ—‘</button>
                                                </>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                <button className="btn btn-add" onClick={() => {
                                    const newId = Math.max(...gastosFijos.map(g => g.id), 0) + 1;
                                    setGastosFijos([...gastosFijos, {id: newId, categoria: 'Nuevo gasto', presupuesto: 0, pagado: false}]);
                                    setEditingFijo(newId);
